<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Hello World</title>
</head>
<script src="js/pixi.min.js"></script>
<body>

<div id="view"></div>
<div id="controls">
    <label>Начальная скорость (м/с): <input type="text" value="10" id="speed" /></label>
    <label>Угол к горизонту (град): <input type="text" value="70" id="angle" /></label>
    <button id="play">Запуск!</button>
    <button id="clear">Очистить</button>
</div>

<script type="text/javascript">
    let type = "WebGL";

    if (!PIXI.utils.isWebGLSupported()) {
        type = "canvas";
    }

    PIXI.utils.sayHello(type);

    //Create a Pixi Application
    let app = new PIXI.Application({
            width: 1024,         // default: 800
            height: 512,        // default: 600
            antialias: true,    // default: false
            transparent: false, // default: false
            resolution: 1       // default: 1
        }
    );

    let sprite;
    let startTime;

    let angle = document.getElementById('angle').value;
    let speed = document.getElementById('speed').value;

    let state = wait;

    const g = 9.81;

    const spriteContainer = new PIXI.Container();
    const trajectContainer = new PIXI.Container();

    //Add the canvas that Pixi automatically created for you to the HTML document
    document.getElementById('view').appendChild(app.view);

    document.getElementById('play').addEventListener('click', function () {
        angle = document.getElementById('angle').value;
        speed = document.getElementById('speed').value;

        sprite.position.set(0, 512);
        startTime = Date.now();

        state = play;
    });

    document.getElementById('clear').addEventListener('click', function () {
        trajectContainer.removeChildren();
    });

    PIXI.loader
        .add([
            { name: 'ball',url: 'img/ball.png'},
        ])
        .load(setup);

    function setup() {
        sprite = new PIXI.Sprite(
            PIXI.loader.resources['ball'].texture
        );
        sprite.scale.set(1/8, 1/8);
        sprite.anchor.set(0.5, 0.5);
        sprite.position.set(0, 512);

        app.stage.addChild(trajectContainer);
        app.stage.addChild(spriteContainer);

        spriteContainer.addChild(sprite);

        app.ticker.add(delta => gameLoop(delta));
    }

    function gameLoop(delta){
        state(delta);
    }

    function wait(delta) {

    }

    function play(delta) {
        const t = (Date.now() - startTime) / 1000;

        const x = speed * t * Math.cos(angle * Math.PI / 180);
        const y = speed * t * Math.sin(angle * Math.PI / 180) - g * t * t / 2;

        const xpos = 128 * x;
        const ypos = 512 - 128 * y;

        if (y > 0) {
            let line = new PIXI.Graphics();
            line.lineStyle(4, 0xFFFFFF, 1);
            line.moveTo(sprite.x, sprite.y);
            line.lineTo(xpos, ypos);

            trajectContainer.addChild(line);

            sprite.position.set(xpos, ypos);
        } else {
            sprite.position.set(sprite.x, 512 - 12);
            state = wait;
        }
    }
</script>
</body>
</html>
